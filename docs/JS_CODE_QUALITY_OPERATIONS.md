# JS Code Quality Operations Plan

## Overview
- Total JS/ESM files (excl. `node_modules`): 755 (`.netlify`: 325, `netlify`: 111, `js`: 263, remaining folders: 56)
- Current automated coverage only touches 4 backend files (`js/backend/config/supabase.js`, `js/backend/middleware/auth.js`, `js/backend/routes/gdpr.js`, `js/backend/routes/legal.js`).
- Goal: bring mission-critical runtime code under automated tests, archive or delete generated artifacts, and close gaps in documentation + linting.

## Cross-Cutting Tasks
- [ ] Extend `package.json` Jest config to include `netlify/functions`, `frontend/js`, `utils`, and `js/backend/services` with appropriate moduleNameMapper + `jsdom` env.
- [ ] Add new Jest projects (or vitest) for browser code (`frontend/js`, `frontend/js/feedback-widget.js`).
- [ ] Configure integration test harness with Supabase + mocked Slack webhooks for Netlify functions (`netlify/functions/__tests__`).
- [ ] Add lint job (ESLint + Prettier) covering all JS paths; add to CI.
- [ ] Update `backend/jest.config.cjs` (or root config) to fail when uncovered files regress (set coverage thresholds once baseline tests exist).
- [ ] Document manual QA fallback in `docs/QA_PLAYBOOK.md` until automation complete.

## Directory Audit & Required Operations

### `.netlify/` (325 files)
- Generated by Netlify CLI; exclude from repo + coverage.
- [ ] Add `.netlify/` to `.gitignore` and clean committed artifacts.
- [ ] Ensure CI deletes `.netlify/functions-serve` before running coverage (reduces noise).

### `netlify/functions/` (111 runtime files)
- Production serverless functions.
- [ ] For each business-critical function (auth, feedback, monitoring, analytics, payments): create unit tests with `jest` + `nock`/`msw` to mock external APIs (Supabase, Slack, UptimeRobot, PayPal).
- [ ] Build shared test utilities in `netlify/functions/__tests__/helpers` for env var injection, Supabase mock, Slack webhook spy.
- [ ] Introduce `index.test.mjs` smoke suite verifying every handler exports `handler(event, context)`.
- [ ] Add schema validation tests for request/response payloads where Zod/JSON schema exists.

### `frontend/js/` (9 files)
- Browser widgets, including new feedback widget.
- [ ] Add `jest.config.frontend.cjs` (jsdom env) and test cases for `feedback-widget.js`, `language-switcher.js`, `logo-cookie-manager.js`, `availability-monitor.js`.
- [ ] Create accessibility snapshot tests for DOM injection (e.g., `feedback-widget` attaches floating button, handles form submission state).
- [ ] Add Lighthouse smoke tests in CI to cover lazy-loading changes and analytics injection (tie into existing `scripts/seo-validation.sh`).

### `backend/` (13 files)
- Express server entrypoints + scripts.
- [ ] Ensure `backend/server.js` imports align with monorepo (currently multiple server variants). Decide single entrypoint and delete unused variants or mark archived.
- [ ] Add Supertest coverage for REST routes triggered via `backend/tests` to ensure parity with `netlify/functions` endpoints.
- [ ] Review scripts (`backend/scripts/*.js`) and migrate duplicates into `scripts/` root or TypeScript if kept.

### `js/` workspace (263 files)
Large historical bundle; break into workstreams:
- **`js/backend/**/*.js` (approx. 130 files)**
  - [ ] Confirm active usage; many appear legacy. Move unused files to `archive/` or delete after verification.
  - [ ] For active services (`services/*.js`, `routes/*.js`, `models/*.js`), add Jest unit tests leveraging existing mocks (`js/backend/tests`).
  - [ ] Deduplicate PayPal test harnesses (`paypal-*.js` scripts) and integrate into a single E2E test suite.
- **`js/netlify/functions/*.js` (legacy)**
  - [ ] Replace or delete once equivalent `.mjs` function exists in `netlify/functions/`.
  - [ ] If still referenced, port to ESM + add shared tests.
- **`js/frontend/js/*.js` & duplicates**
  - [ ] Ensure these either feed `frontend/` bundle or archive.
- **Root `js/*.js` scripts**
  - [ ] Convert to documented CLI tools (with `scripts/` parity) or remove.

### `organized/js/` (12 files)
- Collection of orchestration scripts & smoke tests.
- [ ] Decide retention strategy; if still part of QA, add to `npm run smoke:organized`.
- [ ] Document execution order and dependencies.

### `scripts/` (8 files)
- Operational automation.
- [ ] Add unit tests where feasible (e.g., pure functions) or acceptance tests (execute with fixture env variables).
- [ ] Ensure PowerShell equivalents exist for Windows usage if scripts assume bash/node.

### `tests/` (5 orchestrators)
- Suites targeting Netlify functions.
- [ ] Align with updated Jest configs; ensure they import the ESM modules correctly and run under Node 20.
- [ ] Convert ad-hoc `require` patterns to `import` + add coverage assertions.

### `utils/` (6 files)
- Shared security utilities.
- [ ] Add unit tests measuring rate-limiter behavior, secureLogger redaction, and token hashing.
- [ ] Integrate utils into primary service tests to prevent drift.

### `coverage/` (3 files)
- Generated outputs.
- [ ] Mark as artifacts; exclude from lint/test.

## Documentation Updates
- [ ] Create `docs/QA_PLAYBOOK.md` summarizing manual regression coverage until automated tests land.
- [ ] Update `docs/CRITICAL_FOLLOWUP_STATUS.md` with new testing action items.
- [ ] Add section to `ENVIRONMENT_SETUP_GUIDE.md` linking to required env vars for test suites (Supabase anon/service role, Slack webhook, PayPal sandbox).

## Execution Roadmap
1. Cleanup generated folders (`.netlify`, `coverage/` copies) & adjust `.gitignore`.
2. Establish testing infrastructure (Jest projects, helpers, coverage settings).
3. Prioritize Netlify functions (auth, feedback, monitoring) → backend services → frontend widgets.
4. Triage legacy `js/` scripts: archive or integrate.
5. Finalize documentation + CI enforcement.

Once completed, rerun `npm test -- --coverage` and target ≥80% statements for runtime-critical directories (`netlify/functions`, `frontend/js`, `utils`).
