<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - SichrPlace</title>
  <link rel="icon" type="image/png" href="img/logo.jpg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "smib1d4kq5");
  </script>

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2FG8XLMM35"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2FG8XLMM35', {
      'anonymize_ip': true,
      'allow_google_signals': false,
      'allow_ad_personalization_signals': false
    });
  </script>
  
  <style>
    :root {
      --primary: #2563EB;
      --secondary: #F3F4F6;
      --accent: #10B981;
      --muted: #6B7280;
      --danger: #EF4444;
      --background: #FFFFFF;
      --surface: #F9FAFB;
      --text: #1F2937;
      --border: #E5E7EB;
      --heading-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --body-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--body-font);
      background: var(--surface);
      height: 100vh;
      overflow: hidden;
    }

    .chat-container {
      display: flex;
      height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
    }

    /* Sidebar Styles */
    .sidebar {
      width: 360px;
      background: white;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .sidebar-header h1 {
      font-family: var(--heading-font);
      font-size: 1.5rem;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header h1 i {
      color: var(--primary);
    }

    .new-message-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
      width: 100%;
      justify-content: center;
    }

    .new-message-btn:hover {
      background: #1D4ED8;
    }

    .search-box {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: var(--surface);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
    }

    .loading {
      padding: 40px 20px;
      text-align: center;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .conversation-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .conversation-item:hover {
      background: var(--surface);
    }

    .conversation-item.active {
      background: #EBF4FF;
      border-right: 3px solid var(--primary);
    }

    .conversation-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      position: relative;
      flex-shrink: 0;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border: 2px solid white;
      border-radius: 50%;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-type {
      background: var(--accent);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .user-type.landlord {
      background: var(--primary);
    }

    .last-message {
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .unread-badge {
      background: var(--danger);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 0.7rem;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: var(--text);
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text);
      padding: 8px;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header .avatar {
      width: 40px;
      height: 40px;
    }

    .chat-participant-info h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .chat-participant-info p {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .chat-actions {
      display: flex;
      gap: 8px;
    }

    .chat-action-btn {
      background: none;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--muted);
      transition: all 0.2s;
    }

    .chat-action-btn:hover {
      background: var(--surface);
      color: var(--text);
    }

    .chat-action-btn.danger:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--surface);
      scroll-behavior: smooth;
    }

    .message-date {
      text-align: center;
      margin: 20px 0;
      font-size: 0.85rem;
      color: var(--muted);
      position: relative;
    }

    .message-date::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--border);
      z-index: 1;
    }

    .message-date span {
      background: var(--surface);
      padding: 0 12px;
      position: relative;
      z-index: 2;
    }

    .message {
      display: flex;
      margin-bottom: 16px;
      gap: 8px;
    }

    .message.own {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .message-content {
      max-width: 70%;
      display: flex;
      flex-direction: column;
    }

    .message.own .message-content {
      align-items: flex-end;
    }

    .message-bubble {
      background: white;
      padding: 12px 16px;
      border-radius: 16px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .message.own .message-bubble {
      background: var(--primary);
      color: white;
    }

    .message-text {
      margin: 0;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message-attachments {
      margin-top: 8px;
    }

    .attachment {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 0, 0, 0.1);
      padding: 6px 10px;
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      font-size: 0.85rem;
      margin-right: 8px;
      margin-bottom: 4px;
    }

    .message.own .attachment {
      background: rgba(255, 255, 255, 0.2);
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .message.own .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    .message-status {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: white;
      border-top: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--muted);
    }

    .typing-indicator .avatar {
      width: 28px;
      height: 28px;
      font-size: 0.7rem;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .message-input-container {
      background: white;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }

    .message-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      background: var(--surface);
      border-radius: 12px;
      padding: 8px;
    }

    .attachment-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .attachment-btn:hover {
      background: var(--border);
      color: var(--text);
    }

    #file-input {
      display: none;
    }

    .message-input {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.4;
      padding: 8px 12px;
      background: transparent;
      max-height: 120px;
      min-height: 20px;
    }

    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover:not(:disabled) {
      background: #1D4ED8;
    }

    .send-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .chat-container {
        max-width: 100%;
      }

      .sidebar {
        position: absolute;
        left: -360px;
        top: 0;
        height: 100%;
        z-index: 1000;
      }

      .sidebar.open {
        transform: translateX(360px);
      }

      .mobile-menu-btn {
        display: block;
      }

      .chat-header {
        padding: 12px 16px;
      }

      .messages-container {
        padding: 16px;
      }

      .message-input-container {
        padding: 12px 16px;
      }

      .conversation-item {
        padding: 12px 16px;
      }

      .avatar {
        width: 40px;
        height: 40px;
      }

      .chat-header .avatar {
        width: 36px;
        height: 36px;
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .sidebar.open {
        transform: translateX(100%);
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Sidebar - Conversations List -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1><i class="fas fa-comments"></i> Messages</h1>
        <button class="new-message-btn" onclick="openNewMessageModal()">
          <i class="fas fa-plus"></i> New
        </button>
      </div>
      
      <div class="search-box">
        <input type="text" class="search-input" placeholder="Search conversations..." 
               id="conversation-search" onkeyup="searchConversations()">
      </div>
      
      <div class="conversations-list" id="conversations-list">
        <div class="loading">
          <div class="loading-spinner"></div>
          Loading conversations...
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main" id="chat-main">
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-comments"></i>
        </div>
        <h3>Welcome to SichrPlace Messages</h3>
        <p>Select a conversation from the left to start messaging with landlords and applicants securely.</p>
      </div>

      <!-- Chat Header (hidden initially) -->
      <div class="chat-header" id="chat-header" style="display: none;">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        
        <div class="chat-header-info">
          <div class="avatar" id="chat-avatar">
            <img id="chat-avatar-img" alt="User" style="display: none;">
            <span id="chat-avatar-text"></span>
            <div class="online-indicator" id="online-indicator" style="display: none;"></div>
          </div>
          <div class="chat-participant-info">
            <h3 id="chat-participant-name">Loading...</h3>
            <p id="chat-participant-status">Online</p>
          </div>
        </div>
        
        <div class="chat-actions">
          <button class="chat-action-btn" onclick="viewProfile()" title="View Profile">
            <i class="fas fa-user"></i>
          </button>
          <button class="chat-action-btn" onclick="searchMessages()" title="Search Messages">
            <i class="fas fa-search"></i>
          </button>
          <button class="chat-action-btn" onclick="showChatOptions()" title="More Options">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <button class="chat-action-btn danger" onclick="reportConversation()" title="Report">
            <i class="fas fa-flag"></i>
          </button>
        </div>
      </div>

      <!-- Messages Container (hidden initially) -->
      <div class="messages-container" id="messages-container" style="display: none;">
        <!-- Messages will be loaded here -->
      </div>

      <!-- Typing Indicator (hidden initially) -->
      <div class="typing-indicator" id="typing-indicator" style="display: none;">
        <div class="avatar">
          <span id="typing-avatar-text"></span>
        </div>
        <div>
          <span id="typing-user-name">Someone</span> is typing
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>

      <!-- Message Input (hidden initially) -->
      <div class="message-input-container" id="message-input-container" style="display: none;">
        <div class="message-input-wrapper">
          <button class="attachment-btn" onclick="document.getElementById('file-input').click()" title="Attach File">
            <i class="fas fa-paperclip"></i>
          </button>
          <input type="file" id="file-input" multiple accept="image/*,.pdf,.doc,.docx" onchange="handleFileSelect(event)">
          
          <textarea class="message-input" id="message-input" 
                    placeholder="Type your message..." 
                    rows="1" 
                    onkeydown="handleKeyDown(event)"
                    oninput="handleTyping()"></textarea>
          
          <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled title="Send Message">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        
        <!-- File Preview Area -->
        <div id="file-preview" style="margin-top: 12px; display: none;">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="file-preview-list">
            <!-- File previews will appear here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- New Message Modal -->
  <div id="new-message-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-family: var(--heading-font);">New Message</h3>
        <button onclick="closeNewMessageModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">×</button>
      </div>
      
      <form id="new-message-form" onsubmit="createNewConversation(event)">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">To:</label>
          <input type="email" id="recipient-email" placeholder="Enter email address" 
                 style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;" required>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Subject:</label>
          <input type="text" id="message-subject" placeholder="What's this about?" 
                 style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;">
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Message:</label>
          <textarea id="initial-message" placeholder="Write your message..." rows="4" 
                    style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;" required></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" onclick="closeNewMessageModal()" 
                  style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" 
                  style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
            Send Message
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global state
    let currentUser = null;
    let currentConversation = null;
    let conversations = [];
    let messages = [];
    let typingTimeout = null;
    let selectedFiles = [];
    let lastTypingNotification = 0;

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    async function initializeApp() {
      try {
        // Check authentication
        const token = localStorage.getItem('sichrplace_token');
        if (!token) {
          window.location.href = 'login.html?redirect=chat.html';
          return;
        }

        // Track page view
        if (typeof gtag !== 'undefined') {
          gtag('event', 'page_view', {
            page_title: 'Messages',
            page_location: window.location.href
          });
        }

        // Load user data and conversations
        await loadCurrentUser();
        await loadConversations();

        // Check for conversation ID in URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('conversation');
        if (conversationId) {
          await selectConversation(conversationId);
        }

        // Set up real-time updates (if available)
        setupRealTimeUpdates();

      } catch (error) {
        console.error('Failed to initialize app:', error);
        showNotification('Failed to load messages. Please refresh the page.', 'error');
      }
    }

    async function loadCurrentUser() {
      try {
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('sichrplace_token')}`
          }
        });

        if (response.ok) {
          currentUser = await response.json();
        } else {
          throw new Error('Failed to load user data');
        }
      } catch (error) {
        console.error('Error loading user:', error);
        // Redirect to login if unauthorized
        if (error.status === 401) {
          localStorage.removeItem('sichrplace_token');
          window.location.href = 'login.html?redirect=chat.html';
        }
      }
    }

    async function loadConversations() {
      try {
        const response = await fetch('/api/conversations', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('sichrplace_token')}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          conversations = data.conversations;
          renderConversations();
        } else {
          throw new Error('Failed to load conversations');
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
        document.getElementById('conversations-list').innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--muted);">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            Failed to load conversations
            <br><button onclick="loadConversations()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
          </div>
        `;
      }
    }

    function renderConversations() {
      const container = document.getElementById('conversations-list');
      
      if (conversations.length === 0) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--muted);">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            No conversations yet
            <br><button onclick="openNewMessageModal()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">Start a conversation</button>
          </div>
        `;
        return;
      }

      container.innerHTML = conversations.map(conv => {
        const otherParticipant = conv.participants.find(p => p.user._id !== currentUser._id);
        if (!otherParticipant) return '';

        const user = otherParticipant.user;
        const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
        const lastMessageTime = conv.lastMessage ? formatTime(conv.lastMessage.timestamp) : '';
        
        return `
          <div class="conversation-item ${currentConversation && currentConversation._id === conv._id ? 'active' : ''}" 
               onclick="selectConversation('${conv._id}')">
            <div class="conversation-header">
              <div class="avatar">
                ${user.profilePicture ? 
                  `<img src="${user.profilePicture}" alt="${user.name}">` : 
                  `<span>${initials}</span>`
                }
                <div class="online-indicator" style="display: none;"></div>
              </div>
              <div class="conversation-info">
                <div class="conversation-name">
                  ${user.name || 'Unknown User'}
                  <span class="user-type ${otherParticipant.role}">${otherParticipant.role}</span>
                </div>
                <div class="last-message">
                  ${conv.lastMessage ? conv.lastMessage.content : 'No messages yet'}
                </div>
              </div>
            </div>
            <div class="conversation-meta">
              <span>${lastMessageTime}</span>
              ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function selectConversation(conversationId) {
      try {
        // Track conversation selection
        if (typeof gtag !== 'undefined') {
          gtag('event', 'conversation_selected', {
            event_category: 'messaging'
          });
        }

        const response = await fetch(`/api/conversations/${conversationId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('sichrplace_token')}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          currentConversation = data.conversation;
          messages = data.messages;
          
          renderChatHeader();
          renderMessages();
          showChatInterface();
          updateConversationReadStatus();
          
          // Close sidebar on mobile
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
          }
        } else {
          throw new Error('Failed to load conversation');
        }
      } catch (error) {
        console.error('Error selecting conversation:', error);
        showNotification('Failed to load conversation', 'error');
      }
    }

    function renderChatHeader() {
      if (!currentConversation) return;

      const otherParticipant = currentConversation.participants.find(p => p.user._id !== currentUser._id);
      if (!otherParticipant) return;

      const user = otherParticipant.user;
      const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';

      document.getElementById('chat-participant-name').textContent = user.name || 'Unknown User';
      document.getElementById('chat-participant-status').textContent = 
        otherParticipant.role.charAt(0).toUpperCase() + otherParticipant.role.slice(1);
      
      const avatarImg = document.getElementById('chat-avatar-img');
      const avatarText = document.getElementById('chat-avatar-text');
      
      if (user.profilePicture) {
        avatarImg.src = user.profilePicture;
        avatarImg.style.display = 'block';
        avatarText.style.display = 'none';
      } else {
        avatarImg.style.display = 'none';
        avatarText.style.display = 'block';
        avatarText.textContent = initials;
      }
    }

    function renderMessages() {
      const container = document.getElementById('messages-container');
      
      if (messages.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--muted);">
            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
            <h3 style="margin: 0 0 8px 0;">Start the conversation</h3>
            <p style="margin: 0;">Send a message to begin chatting.</p>
          </div>
        `;
        return;
      }

      let html = '';
      let lastDate = '';
      
      messages.forEach((message, index) => {
        const messageDate = formatDate(message.createdAt);
        
        // Add date separator
        if (messageDate !== lastDate) {
          html += `<div class="message-date"><span>${messageDate}</span></div>`;
          lastDate = messageDate;
        }

        const isOwn = message.sender._id === currentUser._id;
        const sender = message.sender;
        const initials = sender.name ? sender.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
        
        html += `
          <div class="message ${isOwn ? 'own' : ''}">
            <div class="message-avatar">
              ${sender.profilePicture ? 
                `<img src="${sender.profilePicture}" alt="${sender.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                initials
              }
            </div>
            <div class="message-content">
              <div class="message-bubble">
                <p class="message-text">${escapeHtml(message.content)}</p>
                ${message.attachments && message.attachments.length > 0 ? renderAttachments(message.attachments) : ''}
              </div>
              <div class="message-time">
                ${formatTime(message.createdAt)}
                ${isOwn ? renderMessageStatus(message) : ''}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      scrollToBottom();
    }

    function renderAttachments(attachments) {
      return `
        <div class="message-attachments">
          ${attachments.map(att => `
            <a href="${att.fileUrl}" target="_blank" class="attachment">
              <i class="fas fa-${getFileIcon(att.mimeType)}"></i>
              <span>${att.originalName}</span>
            </a>
          `).join('')}
        </div>
      `;
    }

    function renderMessageStatus(message) {
      let icon = 'far fa-clock'; // sent
      let text = 'Sent';
      
      if (message.status === 'delivered') {
        icon = 'fas fa-check';
        text = 'Delivered';
      } else if (message.status === 'read') {
        icon = 'fas fa-check-double';
        text = 'Read';
      }
      
      return `
        <div class="message-status">
          <i class="${icon}"></i>
          <span>${text}</span>
        </div>
      `;
    }

    function showChatInterface() {
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('chat-header').style.display = 'flex';
      document.getElementById('messages-container').style.display = 'flex';
      document.getElementById('message-input-container').style.display = 'block';
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const content = input.value.trim();
      
      if (!content && selectedFiles.length === 0) return;
      if (!currentConversation) return;

      try {
        // Track message sending
        if (typeof gtag !== 'undefined') {
          gtag('event', 'message_sent', {
            event_category: 'messaging',
            custom_parameters: {
              has_attachments: selectedFiles.length > 0
            }
          });
        }

        const formData = new FormData();
        formData.append('content', content);
        
        selectedFiles.forEach(file => {
          formData.append('attachments', file);
        });

        const response = await fetch(`/api/conversations/${currentConversation._id}/messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('sichrplace_token')}`
          },
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          messages.push(data.message);
          renderMessages();
          
          // Clear input
          input.value = '';
          selectedFiles = [];
          clearFilePreview();
          updateSendButton();
          
          // Update conversation in sidebar
          await loadConversations();
          
        } else {
          throw new Error('Failed to send message');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Failed to send message', 'error');
      }
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function handleTyping() {
      const input = document.getElementById('message-input');
      updateSendButton();
      
      // Auto-resize textarea
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      
      // Notify other participants that user is typing
      const now = Date.now();
      if (now - lastTypingNotification > 2000) {
        lastTypingNotification = now;
        // Send typing notification (implement with WebSocket/SSE)
      }
    }

    function updateSendButton() {
      const input = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const hasContent = input.value.trim().length > 0 || selectedFiles.length > 0;
      
      sendBtn.disabled = !hasContent;
    }

    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      selectedFiles = [...selectedFiles, ...files];
      
      // Limit to 5 files
      if (selectedFiles.length > 5) {
        selectedFiles = selectedFiles.slice(0, 5);
        showNotification('Maximum 5 files allowed', 'warning');
      }
      
      renderFilePreview();
      updateSendButton();
    }

    function renderFilePreview() {
      const container = document.getElementById('file-preview');
      const list = document.getElementById('file-preview-list');
      
      if (selectedFiles.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      list.innerHTML = selectedFiles.map((file, index) => `
        <div style="display: flex; align-items: center; gap: 8px; background: var(--secondary); padding: 8px 12px; border-radius: 8px;">
          <i class="fas fa-${getFileIcon(file.type)}"></i>
          <span style="font-size: 0.85rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
          <button onclick="removeFile(${index})" style="background: none; border: none; color: var(--muted); cursor: pointer; padding: 4px;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderFilePreview();
      updateSendButton();
    }

    function clearFilePreview() {
      document.getElementById('file-preview').style.display = 'none';
      document.getElementById('file-input').value = '';
    }

    function getFileIcon(mimeType) {
      if (mimeType.startsWith('image/')) return 'image';
      if (mimeType.includes('pdf')) return 'file-pdf';
      if (mimeType.includes('doc')) return 'file-word';
      return 'file';
    }

    function scrollToBottom() {
      const container = document.getElementById('messages-container');
      container.scrollTop = container.scrollHeight;
    }

    function updateConversationReadStatus() {
      // Update the conversation item to remove unread badge
      if (currentConversation) {
        const convElement = document.querySelector(`[onclick="selectConversation('${currentConversation._id}')"]`);
        if (convElement) {
          const badge = convElement.querySelector('.unread-badge');
          if (badge) badge.remove();
        }
      }
    }

    // Modal functions
    function openNewMessageModal() {
      document.getElementById('new-message-modal').style.display = 'flex';
      
      // Track modal opening
      if (typeof gtag !== 'undefined') {
        gtag('event', 'new_message_modal_opened', {
          event_category: 'messaging'
        });
      }
    }

    function closeNewMessageModal() {
      document.getElementById('new-message-modal').style.display = 'none';
      document.getElementById('new-message-form').reset();
    }

    async function createNewConversation(event) {
      event.preventDefault();
      
      const recipientEmail = document.getElementById('recipient-email').value;
      const subject = document.getElementById('message-subject').value;
      const initialMessage = document.getElementById('initial-message').value;
      
      try {
        const response = await fetch('/api/conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('sichrplace_token')}`
          },
          body: JSON.stringify({
            recipientEmail,
            subject,
            initialMessage,
            type: 'general'
          })
        });

        if (response.ok) {
          const data = await response.json();
          closeNewMessageModal();
          await loadConversations();
          await selectConversation(data.conversation._id);
          showNotification('Message sent successfully!', 'success');
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('Error creating conversation:', error);
        showNotification('Failed to send message', 'error');
      }
    }

    // Search and other functions
    function searchConversations() {
      const query = document.getElementById('conversation-search').value.toLowerCase();
      const items = document.querySelectorAll('.conversation-item');
      
      items.forEach(item => {
        const name = item.querySelector('.conversation-name').textContent.toLowerCase();
        const lastMessage = item.querySelector('.last-message').textContent.toLowerCase();
        
        if (name.includes(query) || lastMessage.includes(query)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function setupRealTimeUpdates() {
      // Implement WebSocket or Server-Sent Events for real-time updates
      // This is a placeholder for future implementation
      console.log('Real-time updates would be set up here');
    }

    // Utility functions
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else if (diffDays < 7) {
        return date.toLocaleDateString([], { weekday: 'short' });
      } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
      }
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return 'Today';
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else {
        return date.toLocaleDateString([], { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showNotification(message, type = 'info') {
      const colors = {
        success: '#10B981',
        error: '#EF4444',
        warning: '#F59E0B',
        info: '#3B82F6'
      };
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        font-weight: 500;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Chat action functions (placeholder implementations)
    function viewProfile() {
      if (currentConversation) {
        const otherParticipant = currentConversation.participants.find(p => p.user._id !== currentUser._id);
        if (otherParticipant) {
          window.open(`/profile/${otherParticipant.user._id}`, '_blank');
        }
      }
    }

    function searchMessages() {
      // Implement message search functionality
      showNotification('Message search coming soon!', 'info');
    }

    function showChatOptions() {
      // Implement chat options menu
      showNotification('More options coming soon!', 'info');
    }

    function reportConversation() {
      if (currentConversation && confirm('Report this conversation for inappropriate content?')) {
        // Implement reporting functionality
        showNotification('Conversation reported. Thank you for keeping SichrPlace safe.', 'success');
      }
    }

    // CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
