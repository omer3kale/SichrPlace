<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Search - SichrPlace</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563EB;
            --secondary: #F9FAFB;
            --accent: #40E0D0;
            --text: #222;
            --muted: #6b7280;
            --card: #fff;
            --radius: 18px;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --heading-font: "Poppins", sans-serif;
            --body-font: "Roboto", sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--body-font);
            background: var(--secondary);
            color: var(--text);
        }

        header {
            background: var(--card);
            box-shadow: var(--shadow);
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-text {
            display: flex;
            align-items: baseline;
            font-family: var(--heading-font);
            font-weight: 700;
            font-size: 1.8rem;
            line-height: 1;
        }

        .sichr-text {
            color: var(--primary);
        }

        .place-text {
            color: var(--primary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--heading-font);
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--primary);
            text-decoration: none;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            font-family: var(--heading-font);
            font-size: 1rem;
            transition: color 0.2s;
        }

        .nav a:hover, .nav a.active {
            color: var(--accent);
        }

        #user-nav-section {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            font-family: var(--heading-font);
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            text-align: center;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: var(--muted);
            text-align: center;
            margin-bottom: 40px;
        }

        .search-container {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 40px;
        }

        .search-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        .search-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
            font-family: var(--heading-font);
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            font-family: var(--body-font);
            transition: border-color 0.2s;
        }

        .search-group input:focus,
        .search-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-group.wide {
            flex: 2;
        }

        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .amenity-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .amenity-checkbox:hover {
            background: #e9ecef;
        }

        .amenity-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: var(--heading-font);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--muted);
            color: white;
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #2BC4B6;
        }

        .results-container {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-info {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-suggestions {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .suggestions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .suggestion-tag {
            background: #f3f4f6;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .suggestion-tag:hover {
            background: var(--accent);
            color: white;
        }

        .apartment-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            transition: transform 0.2s;
        }

        .apartment-card:hover {
            transform: translateY(-2px);
        }

        .listing-card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .listing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .listing-image {
            height: 200px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .listing-price-tag {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .listing-content {
            padding: 20px;
        }

        .listing-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0 0 8px 0;
            font-family: var(--heading-font);
        }

        .listing-location {
            color: var(--muted);
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .listing-features {
            display: flex;
            gap: 16px;
            margin: 12px 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .listing-features span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .listing-tags {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag.pet-pet-friendly {
            background: #dcfce7;
            color: #166534;
        }

        .tag.pet-no-pets {
            background: #fef2f2;
            color: #991b1b;
        }

        .tag.furnished {
            background: #dbeafe;
            color: #1e40af;
        }

        .listing-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .listing-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .apartment-image {
            width: 200px;
            height: 150px;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .apartment-details {
            flex: 1;
        }

        .apartment-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .apartment-location {
            color: var(--muted);
            margin-bottom: 10px;
        }

        .apartment-price {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .apartment-features {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--muted);
            font-size: 14px;
        }

        .apartment-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #d1d5db;
        }

        @media (max-width: 768px) {
            header {
                padding: 0 20px;
                height: auto;
                min-height: 70px;
                flex-direction: column;
                gap: 15px;
                padding-top: 15px;
                padding-bottom: 15px;
            }

            .nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 16px;
            }

            .nav a {
                font-size: 0.9rem;
            }

            #user-nav-section {
                gap: 12px;
            }

            .search-row {
                flex-direction: column;
            }

            .apartment-card {
                flex-direction: column;
            }

            .apartment-image {
                width: 100%;
                height: 200px;
            }

            .search-actions {
                flex-direction: column;
            }

            .main-container {
                padding: 20px 15px;
            }

            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
  <header>
    <div class="header-logo">
      <a href="index.html" class="logo" aria-label="SichrPlace">
        <img src="img/sichrplace-logo.jpg" alt="SichrPlace Logo" style="height:48px;width:auto;display:block;">
        <div class="brand-text">
          <span class="sichr-text">Sichr</span><span class="place-text">Place</span>
        </div>
      </a>
    </div>
    <nav class="nav">
      <a href="apartments-listing.html"><i class="fas fa-building"></i> Browse</a>
      <a href="advanced-search.html" class="active"><i class="fas fa-search"></i> Advanced Search</a>
      <a href="add-property.html"><i class="fas fa-plus"></i> List Property</a>
      <span id="user-nav-section">
        <a href="login.html"><i class="fas fa-sign-in-alt"></i> Login</a>
        <a href="create-account.html"><i class="fas fa-user-plus"></i> Sign Up</a>
      </span>
    </nav>
  </header>

    <div class="main-container">
        <h1 class="page-title">🔍 Advanced Search</h1>
        <p class="page-subtitle">Find your perfect apartment with our powerful search filters</p>

        <!-- Search Suggestions -->
        <div class="search-suggestions">
            <h3 style="margin: 0 0 15px 0; color: var(--primary);">Popular Searches</h3>
            <div class="suggestions-grid" id="suggestions-grid">
                <div class="suggestion-tag" onclick="quickSearch('Berlin')">📍 Berlin</div>
                <div class="suggestion-tag" onclick="quickSearch('Munich')">📍 Munich</div>
                <div class="suggestion-tag" onclick="quickSearch('Studio apartment')">🏠 Studio</div>
                <div class="suggestion-tag" onclick="quickSearch('WiFi included')">📶 WiFi</div>
                <div class="suggestion-tag" onclick="quickSearch('Pet friendly')">🐕 Pet Friendly</div>
                <div class="suggestion-tag" onclick="quickSearch('Furnished')">🛋️ Furnished</div>
            </div>
        </div>

        <!-- Advanced Search Form -->
        <div class="search-container">
            <form id="advanced-search-form">
                <!-- Main Search -->
                <div class="search-row">
                    <div class="search-group wide">
                        <label for="query">Search Query</label>
                        <input type="text" id="query" placeholder="Search by location, title, or description..." autocomplete="off">
                    </div>
                </div>

                <!-- Location & Property Type -->
                <div class="search-row">
                    <div class="search-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="City or area...">
                    </div>
                    <div class="search-group">
                        <label for="property-type">Property Type</label>
                        <select id="property-type">
                            <option value="">Any Type</option>
                            <option value="apartment">Apartment</option>
                            <option value="studio">Studio</option>
                            <option value="shared-room">Shared Room</option>
                            <option value="private-room">Private Room</option>
                        </select>
                    </div>
                </div>

                <!-- Price Range -->
                <div class="search-row">
                    <div class="search-group">
                        <label for="min-price">Min Price (€/month)</label>
                        <input type="number" id="min-price" placeholder="0" min="0">
                    </div>
                    <div class="search-group">
                        <label for="max-price">Max Price (€/month)</label>
                        <input type="number" id="max-price" placeholder="No limit" min="0">
                    </div>
                </div>

                <!-- Rooms & Details -->
                <div class="search-row">
                    <div class="search-group">
                        <label for="bedrooms">Bedrooms</label>
                        <select id="bedrooms">
                            <option value="">Any</option>
                            <option value="0">Studio (0 bed)</option>
                            <option value="1">1 Bedroom</option>
                            <option value="2">2 Bedrooms</option>
                            <option value="3">3 Bedrooms</option>
                            <option value="4">4+ Bedrooms</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="bathrooms">Bathrooms</label>
                        <select id="bathrooms">
                            <option value="">Any</option>
                            <option value="1">1+ Bath</option>
                            <option value="2">2+ Baths</option>
                            <option value="3">3+ Baths</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="min-area">Min Area (m²)</label>
                        <input type="number" id="min-area" placeholder="0" min="0">
                    </div>
                </div>

                <!-- Property Preferences -->
                <div class="search-row">
                    <div class="search-group">
                        <label for="furnished">Furnished Status</label>
                        <select id="furnished">
                            <option value="">Any</option>
                            <option value="furnished">Furnished</option>
                            <option value="unfurnished">Unfurnished</option>
                            <option value="semi-furnished">Semi-furnished</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="pet-policy">Pet Policy</label>
                        <select id="pet-policy">
                            <option value="">Any</option>
                            <option value="pet-friendly">Pet Friendly</option>
                            <option value="no-pets">No Pets</option>
                            <option value="cats-only">Cats Only</option>
                            <option value="dogs-only">Dogs Only</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="parking-type">Parking</label>
                        <select id="parking-type">
                            <option value="">Any</option>
                            <option value="included">Included</option>
                            <option value="garage">Garage</option>
                            <option value="street">Street Parking</option>
                            <option value="none">No Parking</option>
                        </select>
                    </div>
                </div>

                <!-- Dates -->
                <div class="search-row">
                    <div class="search-group">
                        <label for="move-in-date">Move-in Date</label>
                        <input type="date" id="move-in-date">
                    </div>
                    <div class="search-group">
                        <label for="move-out-date">Move-out Date</label>
                        <input type="date" id="move-out-date">
                    </div>
                    <div class="search-group">
                        <label for="min-rating">Minimum Rating</label>
                        <select id="min-rating">
                            <option value="">Any Rating</option>
                            <option value="4">4+ Stars</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="5">5 Stars Only</option>
                        </select>
                    </div>
                </div>

                <!-- Enhanced Amenities -->
                <div class="search-row">
                    <div class="search-group wide">
                        <label>Essential Amenities</label>
                        <div class="amenities-grid">
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="wifi">
                                <span>📶 WiFi</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="heating">
                                <span>🔥 Heating</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="air-conditioning">
                                <span>❄️ Air Conditioning</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="washing-machine">
                                <span>🧺 Washing Machine</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="dishwasher">
                                <span>🍽️ Dishwasher</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="kitchen">
                                <span>🍳 Full Kitchen</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Lifestyle Amenities -->
                <div class="search-row">
                    <div class="search-group wide">
                        <label>Lifestyle & Comfort</label>
                        <div class="amenities-grid">
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="balcony">
                                <span>🌿 Balcony/Terrace</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="garden">
                                <span>🌳 Garden Access</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="elevator">
                                <span>🏢 Elevator</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="gym">
                                <span>� Gym/Fitness</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="pool">
                                <span>🏊 Swimming Pool</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="amenities" value="security">
                                <span>🔒 Security System</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Location & Transport -->
                <div class="search-row">
                    <div class="search-group wide">
                        <label>Location Features</label>
                        <div class="amenities-grid">
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="public-transport">
                                <span>� Near Public Transport</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="shopping">
                                <span>🛒 Near Shopping</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="schools">
                                <span>🎓 Near Schools</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="restaurants">
                                <span>🍽️ Near Restaurants</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="parks">
                                <span>🌲 Near Parks</span>
                            </label>
                            <label class="amenity-checkbox">
                                <input type="checkbox" name="location-features" value="city-center">
                                <span>🏙️ City Center</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Search Actions -->
                <div class="search-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-search"></i> Search Apartments
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearSearchForm()">
                        <i class="fa fa-times"></i> Clear All
                    </button>
                    <button type="button" class="btn btn-accent" onclick="saveSearchAlert()">
                        <i class="fa fa-bell"></i> Save Alert
                    </button>
                </div>
            </form>
        </div>

        <!-- Search Results -->
        <div class="results-container">
            <div class="results-header">
                <div class="results-info" id="results-info">
                    Ready to search
                </div>
                <div class="sort-controls">
                    <label for="sort-by">Sort by:</label>
                    <select id="sort-by" onchange="handleSortChange()">
                        <option value="created_at">Newest First</option>
                        <option value="price">Price: Low to High</option>
                        <option value="price_desc">Price: High to Low</option>
                        <option value="size">Size</option>
                    </select>
                </div>
            </div>

            <div id="search-results">
                <!-- Loading state -->
                <div class="loading" id="loading-state" style="display: none;">
                    <i class="fa fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                    <p>Searching apartments...</p>
                </div>

                <!-- No results state -->
                <div class="no-results" id="no-results-state" style="display: none;">
                    <i class="fa fa-search"></i>
                    <h3>No apartments found</h3>
                    <p>Try adjusting your search criteria or use different keywords.</p>
                </div>

                <!-- Results will be populated here -->
                <div id="apartments-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let currentSearchResults = [];
        let currentSortBy = 'created_at';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadPopularSearches();
            updateNavigation();
            
            // Handle form submission
            document.getElementById('advanced-search-form').addEventListener('submit', handleSearchSubmit);
            
            // Auto-search on input changes (debounced)
            const queryInput = document.getElementById('query');
            let searchTimeout;
            queryInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 500);
            });
        });

        // Handle search form submission
        async function handleSearchSubmit(event) {
            event.preventDefault();
            await performSearch();
        }

        // Perform the advanced search
        async function performSearch() {
            showLoadingState();
            
            try {
                const searchParams = buildSearchParams();
                const queryString = new URLSearchParams(searchParams).toString();
                
                const response = await fetch(`${API_BASE_URL}/api/search/advanced?${queryString}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('userToken') || ''}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSearchResults = data.data;
                    displaySearchResults(data.data, data.metadata);
                } else {
                    showNoResultsState();
                    console.error('Search failed:', data.error);
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showNoResultsState();
            }
        }

        // Build search parameters from form
        function buildSearchParams() {
            const amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked'))
                .map(cb => cb.value);
            
            const locationFeatures = Array.from(document.querySelectorAll('input[name="location-features"]:checked'))
                .map(cb => cb.value);
                
            return {
                query: document.getElementById('query').value.trim(),
                location: document.getElementById('location').value.trim(),
                propertyType: document.getElementById('property-type').value,
                minPrice: document.getElementById('min-price').value,
                maxPrice: document.getElementById('max-price').value,
                bedrooms: document.getElementById('bedrooms').value,
                bathrooms: document.getElementById('bathrooms').value,
                minArea: document.getElementById('min-area').value,
                furnished: document.getElementById('furnished').value,
                petPolicy: document.getElementById('pet-policy').value,
                parkingType: document.getElementById('parking-type').value,
                moveInDate: document.getElementById('move-in-date').value,
                moveOutDate: document.getElementById('move-out-date').value,
                minRating: document.getElementById('min-rating').value,
                amenities: amenities.join(','),
                locationFeatures: locationFeatures.join(','),
                sortBy: currentSortBy.includes('_desc') ? currentSortBy.replace('_desc', '') : currentSortBy,
                sortOrder: currentSortBy.includes('_desc') ? 'desc' : 'asc',
                limit: 20
            };
        }

        // Display search results
        function displaySearchResults(apartments, metadata) {
            hideLoadingState();
            
            const resultsInfo = document.getElementById('results-info');
            const apartmentsList = document.getElementById('apartments-list');
            
            if (apartments.length === 0) {
                showNoResultsState();
                return;
            }
            
            resultsInfo.innerHTML = `Found ${apartments.length} apartments`;
            
            apartmentsList.innerHTML = apartments.map(apartment => `
                <div class="apartment-card" onclick="openApartmentDetails('${apartment.id}')">
                    <div class="apartment-image" style="background-image: url('${getApartmentImage(apartment)}');"></div>
                    <div class="apartment-details">
                        <div class="apartment-title">${apartment.title}</div>
                        <div class="apartment-location">📍 ${apartment.location}</div>
                        <div class="apartment-price">€${apartment.price}/month</div>
                        <div class="apartment-features">
                            ${apartment.bedrooms ? `<div class="feature"><i class="fa fa-bed"></i> ${apartment.bedrooms} bed${apartment.bedrooms !== 1 ? 's' : ''}</div>` : ''}
                            ${apartment.bathrooms ? `<div class="feature"><i class="fa fa-bath"></i> ${apartment.bathrooms} bath${apartment.bathrooms !== 1 ? 's' : ''}</div>` : ''}
                            ${apartment.size ? `<div class="feature"><i class="fa fa-expand-arrows-alt"></i> ${apartment.size}m²</div>` : ''}
                            ${apartment.property_type ? `<div class="feature"><i class="fa fa-home"></i> ${formatPropertyType(apartment.property_type)}</div>` : ''}
                        </div>
                        <div class="apartment-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); scheduleViewing('${apartment.id}')">
                                <i class="fa fa-calendar"></i> Schedule Viewing
                            </button>
                            <button class="btn btn-accent" onclick="event.stopPropagation(); contactOwner('${apartment.id}')">
                                <i class="fa fa-envelope"></i> Contact
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function getApartmentImage(apartment) {
            if (apartment.images && apartment.images.length > 0) {
                return apartment.images[0];
            }
            const defaultImages = ['apartment1.jpg', 'apartment2.jpg', 'koeln.jpg'];
            const randomImage = defaultImages[Math.floor(Math.random() * defaultImages.length)];
            return `./img/${randomImage}`;
        }

        function formatPropertyType(type) {
            return type.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function showLoadingState() {
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('no-results-state').style.display = 'none';
            document.getElementById('apartments-list').innerHTML = '';
        }

        function hideLoadingState() {
            document.getElementById('loading-state').style.display = 'none';
        }

        function showNoResultsState() {
            hideLoadingState();
            document.getElementById('no-results-state').style.display = 'block';
            document.getElementById('results-info').innerHTML = 'No results found';
        }

        // Clear search form
        function clearSearchForm() {
            document.getElementById('advanced-search-form').reset();
            document.getElementById('results-info').innerHTML = 'Ready to search';
            document.getElementById('apartments-list').innerHTML = '';
            document.getElementById('no-results-state').style.display = 'none';
        }

        // Quick search from suggestions
        function quickSearch(query) {
            document.getElementById('query').value = query;
            performSearch();
        }

        // Handle sort change
        function handleSortChange() {
            currentSortBy = document.getElementById('sort-by').value;
            if (currentSearchResults.length > 0) {
                performSearch();
            }
        }

        // Save search alert
        async function saveSearchAlert() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            const name = prompt('Enter a name for this search alert:');
            if (!name) return;

            try {
                const searchParams = buildSearchParams();
                
                const response = await fetch(`${API_BASE_URL}/api/search/save-alert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        query: searchParams.query,
                        filters: searchParams
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Show success notification without alert
                    const notification = document.createElement('div');
                    notification.innerHTML = '✅ Search alert saved successfully!';
                    notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;z-index:1000;';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                } else {
                    console.error('Failed to save search alert:', data.error);
                }
                
            } catch (error) {
                console.error('Save alert error:', error);
            }
        }

        // Load popular searches
        async function loadPopularSearches() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/search/popular?limit=8`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const suggestionsGrid = document.getElementById('suggestions-grid');
                    suggestionsGrid.innerHTML = data.data.map(search => 
                        `<div class="suggestion-tag" onclick="quickSearch('${search.query}')">
                            ${getSearchIcon(search.type)} ${search.query}
                        </div>`
                    ).join('');
                }
            } catch (error) {
                // Silently handle error - keep default suggestions
            }
        }

        function getSearchIcon(type) {
            const icons = {
                'location': '📍',
                'property_type': '🏠',
                'amenity': '✨',
                'general': '🔍'
            };
            return icons[type] || '🔍';
        }

        // Clear search form
        function clearSearchForm() {
            document.getElementById('advanced-search-form').reset();
            document.getElementById('apartments-list').innerHTML = '';
            document.getElementById('results-info').textContent = 'Ready to search';
            
            // Uncheck all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Reset results
            currentSearchResults = [];
        }

        // Quick search from suggestions
        function quickSearch(query) {
            document.getElementById('query').value = query;
            performSearch();
        }

        // Handle sort changes
        function handleSortChange() {
            const sortSelect = document.getElementById('sort-by');
            currentSortBy = sortSelect.value;
            
            if (currentSearchResults.length > 0) {
                // Re-sort current results
                const sortedResults = sortApartments(currentSearchResults, currentSortBy);
                displayApartments(sortedResults);
            }
        }

        // Sort apartments locally
        function sortApartments(apartments, sortBy) {
            return [...apartments].sort((a, b) => {
                switch (sortBy) {
                    case 'price':
                        return (a.price || 0) - (b.price || 0);
                    case 'price_desc':
                        return (b.price || 0) - (a.price || 0);
                    case 'size':
                        return (b.area || b.size || 0) - (a.area || a.size || 0);
                    case 'created_at':
                    default:
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                }
            });
        }

        // Display apartments in results
        function displayApartments(apartments) {
            const apartmentsList = document.getElementById('apartments-list');
            
            apartmentsList.innerHTML = apartments.map(apartment => `
                <div class="listing-card" onclick="openApartmentDetails('${apartment.id}')">
                    <div class="listing-image" style="background-image: url('${getApartmentImage(apartment)}');">
                        <div class="listing-price-tag">€${apartment.price}/month</div>
                    </div>
                    <div class="listing-content">
                        <h3 class="listing-title">${apartment.title || apartment.address}</h3>
                        <p class="listing-location">
                            <i class="fas fa-map-marker-alt"></i> ${apartment.location}
                        </p>
                        <div class="listing-features">
                            <span><i class="fas fa-bed"></i> ${apartment.bedrooms || apartment.rooms || 'N/A'}</span>
                            <span><i class="fas fa-bath"></i> ${apartment.bathrooms || 'N/A'}</span>
                            <span><i class="fas fa-expand-arrows-alt"></i> ${apartment.area || apartment.size}m²</span>
                        </div>
                        <div class="listing-tags">
                            ${apartment.petPolicy ? `<span class="tag pet-${apartment.petPolicy}">${formatPetPolicy(apartment.petPolicy)}</span>` : ''}
                            ${apartment.furnished ? `<span class="tag furnished">${formatFurnished(apartment.furnished)}</span>` : ''}
                        </div>
                        <div class="listing-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); scheduleViewing('${apartment.id}')">
                                <i class="fas fa-calendar"></i> Schedule Viewing
                            </button>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); contactOwner('${apartment.id}')">
                                <i class="fas fa-message"></i> Contact
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getApartmentImage(apartment) {
            if (apartment.images && apartment.images.length > 0) {
                return apartment.images[0];
            }
            const defaultImages = ['apartment1.jpg', 'apartment2.jpg', 'koeln.jpg', 'koeln2.jpg'];
            return `./img/${defaultImages[Math.floor(Math.random() * defaultImages.length)]}`;
        }

        function formatPetPolicy(policy) {
            const policies = {
                'pet-friendly': 'Pet Friendly',
                'no-pets': 'No Pets',
                'cats-only': 'Cats Only', 
                'dogs-only': 'Dogs Only'
            };
            return policies[policy] || policy;
        }

        function formatFurnished(status) {
            const statuses = {
                'furnished': 'Furnished',
                'unfurnished': 'Unfurnished',
                'semi-furnished': 'Semi-furnished'
            };
            return statuses[status] || status;
        }

        // Update navigation based on login status
        function updateNavigation() {
            const token = localStorage.getItem('userToken');
            const userName = localStorage.getItem('userName');
            const userNavSection = document.getElementById('user-nav-section');
            
            if (token && userName) {
                userNavSection.innerHTML = `
                    <span style="color: var(--primary); font-weight: 600;">Welcome, ${userName}!</span>
                    <a href="#" onclick="logout()">Logout</a>
                `;
            }
        }

        function logout() {
            localStorage.clear();
            updateNavigation();
            location.reload();
        }
    </script>
</body>
</html>
